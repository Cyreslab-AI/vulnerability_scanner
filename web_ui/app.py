from flask import Flask, render_template, request, jsonify
from vulnerability_scanner.advanced_vulnerability_scanner import VulnerabilityScanner
import yaml

app = Flask(__name__)

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/scan', methods=['POST'])
def scan():
    dependencies_file = request.files['dependenciesFile']
    ecosystem = request.form['ecosystem']

    # Save the uploaded file temporarily
    temp_file_path = 'temp_dependencies.json'
    dependencies_file.save(temp_file_path)

    config = {
        'dependencies_file': temp_file_path,
        'ecosystem': ecosystem,
        # Add other configuration options as needed
    }

    scanner = VulnerabilityScanner(config)
    results = scanner.scan()

    # Clean up the temporary file
    import os
    os.remove(temp_file_path)

    return jsonify(results)

@app.route('/config')
def config():
    return render_template('config.html')

@app.route('/save_config', methods=['POST'])
def save_config():
    config = request.json
    
    # Save the configuration to a YAML file
    with open('config.yaml', 'w') as f:
        yaml.dump(config, f)
    
    return jsonify({"status": "success"})

if __name__ == '__main__':
    app.run(debug=True)